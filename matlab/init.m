J = [0 -1; 1 0];

sim.ts = 1e-6;
sim.fs = 1 / sim.ts;
sim.fs_unit = sim.fs / 2;

grid.f0 = 50;
grid.w0 = 2*pi*grid.f0;
grid.vn = 16e3 / sqrt(3);
grid.vpeak = grid.vn * sqrt(2);
% grid.vpeak_source = grid.vpeak;
grid.sn = 4e6;
grid.in = grid.sn / 3 / grid.vn;
grid.zn = grid.vn / grid.in;
grid.ln = grid.zn / grid.w0;
grid.l1 = 0.16;
grid.r1 = 0.01;
grid.l1_si = grid.l1 * grid.ln;
grid.r1_si = grid.r1 * grid.zn;
ratio = 0.1;
grid.l2 = grid.l1*ratio;
grid.r2 = grid.r1*ratio;
grid.l2_si = grid.l2 * grid.ln;
grid.r2_si = grid.r2 * grid.zn;

% 0: infinite bus
% 1: converter with current controller, 
% 2: open
grid.sel = 0;
% grid.sel = 1;
% grid.sel = 2;

% infinite_bus.gain_w = 1;
infinite_bus.gain_w = 1.02;
% infinite_bus.gain_w = 0.98;
infinite_bus.w = grid.w0 * infinite_bus.gain_w;
% infinite_bus.gain_vpeak = 1;
infinite_bus.gain_vpeak = 1.1;
% infinite_bus.gain_vpeak = 0.9;
infinite_bus.vpeak = grid.vpeak * infinite_bus.gain_vpeak;

pv.open_mcp = 0.3;
pv.pll_enable = 0.1;
pv.ctrl_enable = 0.3;
pv.i_ref = [0.8; 0];

pll.kp = 0.096;
pll.ti = 0.0849;
pll.ki = pll.kp / pll.ti;
pll.enable = 0.1;

ctrl.ts = 200e-6;
ctrl.fs = 1 / ctrl.ts;
% definition of a unit frequency
ctrl.fs_unit = ctrl.fs / 2;
ctrl.l1 = grid.l1;
ctrl.r1 = grid.r1;

if grid.sel == 0
    ctrl.init_vpeak = infinite_bus.gain_vpeak;
    pll.init_w = infinite_bus.gain_w;
else
    ctrl.init_vpeak = 1;
    pll.init_w = 1;
end

pq_ctrl.f_ref = 1.0;
pq_ctrl.vg_ref = 1.0;
pq_ctrl.fp_droop = -0.02;
pq_ctrl.uq_droop = 0.05;
pq_ctrl.kp = 0.45;
pq_ctrl.ki = 11.25;
% pq_ctrl.kp = 1;
% pq_ctrl.ti = 0.1;
% pq_ctrl.ki = pll.kp / pll.ti;
pq_ctrl.enable = 0.4;

% 0: passive
% 1: current control, 
% 2: safety filter
overcurr_ctrl.sel = 2;
overcurr_ctrl.kp = 0.342;
overcurr_ctrl.ki = overcurr_ctrl.kp / 2e-3;
overcurr_ctrl.i_lim = 1.24;
overcurr_ctrl.enableTime = 0.4;

soa.i_lim = 1.18;
soa.m_max = 1.2;

meas.bp50_f1 = (1 - 0.025) * grid.f0 / sim.fs_unit;
meas.bp50_f2 = (1 + 0.025) * grid.f0 / sim.fs_unit;

safety.f_data = [0.0,0.0,0.0,0.0,0.0,0.0,-1963.4954084936207,0.0;0.0,0.0,0.0,0.0,0.0,0.0,0.0,-1963.4954084936207;0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0;0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0;0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0;0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0;0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0;0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0];
safety.G_data = [1963.4954084936207;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;1963.4954084936207;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;1.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;1.0;0.0;0.0;0.0;0.0];
safety.V_data = [-1.0000000000735716,1.6172782491485343e-11,6.1684978641187325e-12,1.465783100232845e-11,3.1398845467506884e-11,-1.7154040321468697e-11,-5.677536205654355e-12,-1.1711215712954013e-11,-3.3128705124128644e-11,3.6911538370693564,-2.395321826218312e-06,0.6863364765872854,-4.206956038864978,-3.367217480065877,-0.10350620769371388,-0.44466372745225524,4.412517579256277,-2.395321826218312e-06,3.691114527386194,4.206981628420729,0.6862989591835219,0.10351249234717226,-3.3671737803834563,-4.412541018733359,-0.4446268362878494,0.6863364765872854,4.206981628420729,17.857183665664824,-1.4887403348286464e-05,-0.3377324649962087,-4.766436813232083,-17.242207114418765,0.0003610044778513785,-4.206956038864978,0.6862989591835219,-1.4887403348286464e-05,17.857194919462223,4.766414258672558,-0.33769241267957417,-0.00031952780577086025,-17.242214448191536,-3.367217480065877,0.10351249234717226,-0.3377324649962087,4.766414258672558,3.739367688863163,-3.888426807956358e-06,0.08561238990207704,-4.988762644701483,-0.10350620769371388,-3.3671737803834563,-4.766436813232083,-0.33769241267957417,-3.888426807956358e-06,3.7393189537896654,4.988783346340025,0.08557297539367427,-0.44466372745225524,-4.412541018733359,-17.242207114418765,-0.00031952780577086025,0.08561238990207704,4.988783346340025,16.734743212464913,-2.670503349231045e-05,4.412517579256277,-0.4446268362878494,0.0003610044778513785,-17.242214448191536,-4.988762644701483,0.08557297539367427,-2.670503349231045e-05,16.734746859497367];
safety.B_data = [-1.0,1.423747414726703e-12,0.0,0.0,0.0,-1.4165842069675917e-12,1.0519643367038407e-12,1.0757921995635227e-12,-1.7044893481791489e-12,0.6503642104128027,-8.670949584762517e-11,-7.723720271258358e-11,6.242827457465205e-10,-7.285363475151831e-09,9.208074897865483e-11,7.076635596149901e-10,4.905825661619718e-10,-8.670949584762517e-11,0.650364213439007,-4.472831707268404e-10,9.7334475851586e-10,1.0323170751318356e-10,-1.063619760470319e-08,-9.55202453597318e-10,8.089603765672348e-11,-7.723720271258358e-11,-4.472831707268404e-10,0.0025000039243545024,-4.225240748109259e-09,1.4760595581001493e-10,3.755358410377111e-10,-3.179745701831944e-09,3.1113704966469857e-09,6.242827457465205e-10,9.7334475851586e-10,-4.225240748109259e-09,0.0025000142568386867,-6.900327658327517e-10,-7.202733513742401e-10,3.560289774139028e-09,-1.0851128930353706e-08,-7.285363475151831e-09,1.0323170751318356e-10,1.4760595581001493e-10,-6.900327658327517e-10,7.966495258235521e-09,-1.11021775841474e-10,-8.733543489773861e-10,-5.551628366153528e-10,9.208074897865483e-11,-1.063619760470319e-08,3.755358410377111e-10,-7.202733513742401e-10,-1.11021775841474e-10,1.1684633079500157e-08,1.2433731280569026e-09,-4.1896965000266563e-10,7.076635596149901e-10,-9.55202453597318e-10,-3.179745701831944e-09,3.560289774139028e-09,-8.733543489773861e-10,1.2433731280569026e-09,7.09495956336665e-09,-2.648878869579398e-09,4.905825661619718e-10,8.089603765672348e-11,3.1113704966469857e-09,-1.0851128930353706e-08,-5.551628366153528e-10,-4.1896965000266563e-10,-2.648878869579398e-09,1.2765349840266652e-08];
safety.nV_data = [1.6172782491485343e-11,7.382307674138713,-4.790643652436624e-06,1.3726729531745707,-8.413912077729956,-6.734434960131754,-0.20701241538742776,-0.8893274549045105,8.825035158512554;6.1684978641187325e-12,-4.790643652436624e-06,7.382229054772388,8.413963256841457,1.3725979183670438,0.20702498469434452,-6.7343475607669125,-8.825082037466718,-0.8892536725756988;1.465783100232845e-11,1.3726729531745707,8.413963256841457,35.71436733132965,-2.9774806696572928e-05,-0.6754649299924174,-9.532873626464166,-34.48441422883753,0.000722008955702757;3.1398845467506884e-11,-8.413912077729956,1.3725979183670438,-2.9774806696572928e-05,35.71438983892445,9.532828517345116,-0.6753848253591483,-0.0006390556115417205,-34.48442889638307;-1.7154040321468697e-11,-6.734434960131754,0.20702498469434452,-0.6754649299924174,9.532828517345116,7.478735377726326,-7.776853615912716e-06,0.17122477980415407,-9.977525289402966;-5.677536205654355e-12,-0.20701241538742776,-6.7343475607669125,-9.532873626464166,-0.6753848253591483,-7.776853615912716e-06,7.478637907579331,9.97756669268005,0.17114595078734854;-1.1711215712954013e-11,-0.8893274549045105,-8.825082037466718,-34.48441422883753,-0.0006390556115417205,0.17122477980415407,9.97756669268005,33.469486424929826,-5.34100669846209e-05;-3.3128705124128644e-11,8.825035158512554,-0.8892536725756988,0.000722008955702757,-34.48442889638307,-9.977525289402966,0.17114595078734854,-5.34100669846209e-05,33.469493718994734];
safety.nB_data = [1.423747414726703e-12,1.3007284208256054,-1.7341899169525035e-10,-1.5447440542516715e-10,1.248565491493041e-09,-1.4570726950303661e-08,1.8416149795730966e-10,1.4153271192299802e-09,9.811651323239435e-10;0.0,-1.7341899169525035e-10,1.300728426878014,-8.945663414536808e-10,1.94668951703172e-09,2.0646341502636712e-10,-2.127239520940638e-08,-1.910404907194636e-09,1.6179207531344697e-10;0.0,-1.5447440542516715e-10,-8.945663414536808e-10,0.005000007848709005,-8.450481496218518e-09,2.9521191162002985e-10,7.510716820754222e-10,-6.359491403663888e-09,6.222740993293971e-09;0.0,1.248565491493041e-09,1.94668951703172e-09,-8.450481496218518e-09,0.005000028513677373,-1.3800655316655035e-09,-1.4405467027484802e-09,7.120579548278056e-09,-2.170225786070741e-08;-1.4165842069675917e-12,-1.4570726950303661e-08,2.0646341502636712e-10,2.9521191162002985e-10,-1.3800655316655035e-09,1.5932990516471042e-08,-2.22043551682948e-10,-1.7467086979547722e-09,-1.1103256732307056e-09;1.0519643367038407e-12,1.8416149795730966e-10,-2.127239520940638e-08,7.510716820754222e-10,-1.4405467027484802e-09,-2.22043551682948e-10,2.3369266159000314e-08,2.486746256113805e-09,-8.379393000053313e-10;1.0757921995635227e-12,1.4153271192299802e-09,-1.910404907194636e-09,-6.359491403663888e-09,7.120579548278056e-09,-1.7467086979547722e-09,2.486746256113805e-09,1.41899191267333e-08,-5.297757739158796e-09;-1.7044893481791489e-12,9.811651323239435e-10,1.6179207531344697e-10,6.222740993293971e-09,-2.170225786070741e-08,-1.1103256732307056e-09,-8.379393000053313e-10,-5.297757739158796e-09,2.5530699680533304e-08];
safety.gamma_V_data = [350.4402998492871];
safety.gamma_B_data = [2770.251466543892];

ratio = 1.0;
load1.r_si = grid.r1_si * ratio;
load1.l_si = grid.l1_si * ratio;
load1.stepTime = 0.8;

